# 2.1 应用层协议原理

应用层软件建立在运输层，网络层，数据链路层，物理层基础之上。

## 2.1.1 网络应用程序体系结构

- 网络体系结构固定，为应用层程序提供了特定的服务集合
- 而应用程序体系结构千变万化
  - 客户-服务器体系结构：
    - 服务器相对固定，便于不同的客户进行访问；
    - 大型服务器需要配备数据中心
  - 对等体系结构（p2p）：
    - 对数据中心的专业服务器依赖较小
    - 客户之间彼此相互连接，直接通信
    - 安全性，性能，可靠性较低

## 2.1.2 进程通信

- 跨计算机的通信通常采用报文发送与接受的方式

- 发起会话的叫客户，接受会话报文的叫服务器

- 套接字
  - 是应用程序和网络之间的可编程的**接口**
  - 套接字在应用层的功能可以被任意操控
  - 套接字在运输层的功能可以操控的权限很少
- IP地址用来指定主机，端口号用来指定进程

## 2.1.3 可供应用程序使用的运输服务、

- 评判协议的标准
  - 可靠数据传输：保证数据传输的完整性
  - 吞吐量：确保的传输速率
  - 定时：时延
  - 安全性：加密程度

## 2.1.4 因特网提供的运输服务

- TCP包括：
  - 面向连接的服务
  - 可靠的数据传输服务
  - TCP具有拥塞控制机制，堵塞时可以抑制数据发送

![image.png](https://tva1.sinaimg.cn/large/008tG9v6ly1h5zgeusiemj311j0cy0x1.jpg)

TCP加强版称为SSL，具有加密功能

- UDP
  - 轻量级运输协议，仅提供最小服务
  - 不可靠，不“握手”
  - 没有拥塞控制机制

***以上协议对吞吐量和延时均没有保证***

## 2.1.5 应用层协议

应用层协议的内容：

- 交换的报文类型， 例如请求报文和响应报文。
- 各种报文类型的语法， 如报文中的各个字段及这些字段是如何描述的。
- 字段的语义， 即这些字段中的信息的含义。
- 确定一个进程何时以及如何发送报文， 对报文进行响应的规则  

# 2.2 Web 和Http

web（万维网）的优点

- 按需操作，选择得到想要的内容

## 2.2.1 HTTP概况

- web页面由对象组成，对象就是一个文件
- url由主机名和路径组成
- 请求与响应
  ![image.png](https://tva1.sinaimg.cn/large/008tG9v6ly1h5zh2wtu9gj30kd0fkacv.jpg)

- 请求报文从套接字接口进入后，就脱离了主机的控制而受TCP协议的控制
- HTTP是无状态协议，并不记录客户的状态
  若要记录，应该用到cookie或者session
- WEB使用的是客户-服务器结构

## 2.2.2 非持续连接和持续连接  

- 非持续连接是指所有请求、响应经过各自单独的TCP连接发送
- 持续连接是指请求、响应经过同一个TCP连接发送
- **HTTP只规定了客户如何与服务端通信，与客户如何解释web页面毫无关系**

并行连接可以缩短响应时间

RTT：往返时间

- 非持续性连接的缺点：
  - 为服务器带来了严重的负担
  - 多了一个创建TCP的RTT时延

## 2.2.3 HTTP报文格式

- 请求报文
  - 请求行
    - 方法字段
      - GET
      - POST
      - PUT
      - DELETE
    - URL字段
    - HTTP版本字段
  - 首部行
    - Host 指定主机名
    - Connection：close 告诉服务器发送请求对象后关闭联机 
    - User-agent 指明用户代理（浏览器类型）
    - Accept-language  用户想得到的对象的语言类型
  - 实体体（只有使用POST才有用）
    - 包含了用户额外的输入值

*get类型也可以发送用户输入的值，方法是包含在url中,(baidu.com/?搜索内容)*

- 请求方法
  - GET
  - POST
  - HEAD 与get类似，但不返回请求对象
  - PUT 允许用户上传对象
  - DELETE 允许用户删除对象

- 响应报文
  - 状态行
    - 协议版本字段
    - 状态码
    - 相应状态信息
  - 首部行
    - Connection:close 告诉用户发送请求对象后关闭联机
    - date 服务器发送响应报文时刻的日期和时间
    - Server 说明服务器的基本信息，类似请求报文的User-agent
    - Last-Modified 指示了对象创建或者最后修改的日期和时间
    - Content-Length 指明了实体体中的对象的字节数
    - Content-type 指明了实体体中的对象的字节数
  - 实体体
  - 状态码
    - 200 0K：请求成功， 信息在返回的响应报文中。
    - 301 Moved Permanently：请求的对象已经被永久转移了， 新的URL定义在响应报
      文的Location:首部行中。 客户软件将自动获取新的URL。
    -  400 Bad Request: 一个通用差错代码， 指示该请求不能被服务器理解。
    -  404 Not Found:被请求的文档不在服务器上。
    - 505 HTTP Version Not Supported:服务器不支持请求报文使用的HTTP协议版本。  

## 2.2.4 cookie

cookie技术的组成:

- 在响应报文中的一个cookie首部行
- 在请求报文中的一个cookie首部行
- 用户端的cookie文件,其由用户的浏览器进行管理
- 位于服务器的一个后端数据库

cookie文件中储存着多行,每行包括一个服务器的主机名和set-cookie中的识别码,
于第一次访问该主机的时候写入,之后每次访问,请求报文中都会带上(cookie:识别码)

**cookie的作用**

cookie 可以用于标识一个用户。用户首次访问一个站点时，可能需要提供-一个用户标识(可能是名字)。在后继会话中，浏览器向服务器传递-个cookie首部，从而向该服务器标识了用户。因此cookie可以在无状态的HTTP之上建立一个用户会话层.

**cookie存在安全问题**

## 2.2.5 web 缓存

过程图示

<img src="https://tva1.sinaimg.cn/large/008tG9v6ly1h62pp50erkj30qm0jgn1v.jpg" alt="image.png" style="zoom:50%;" />
***代理服务器在接收到初始服务器响应后会在本地储存一个副本,再把副本发送给客户***

**web缓存的作用**

- 减少局域网连入因特网的通信量,降低带宽的需求,从而降低了费用
- 减少因特网上的流量

### 2.2.6 条件get请求

包含一个“if-Modified-Since:时间”首部行,来判断web缓存是否需要更新

# 2.3 电子邮件(SMTP协议)

由“用户代理”“邮件服务器”“简单邮件传输”组成

- 用户代理将邮件发送到邮件服务器,或者取出放在邮件服务器里面的邮件
- 每个用户在邮件服务器上都有一个邮箱,管理和维护着发送给他的邮件

- 邮件服务器处理收件邮件服务器故障的措施

 		邮件处于一个报文队列中,每隔一段时间尝试发送一次,若干次后仍然失败后会删除邮件,并通知发送方

每个邮件服务器既是客户端也是服务器

## 2.3.1 SMTP

弊端:

- 每次传输前需要对多媒体数据编码成7比特的ASCII码,接受后需要解码
- 一般不使用中间邮件服务器

邮件发送图示::

![image.png](https://tva1.sinaimg.cn/large/008tG9v6ly1h62ql9aniij31d50blgrh.jpg)

特点:

- 持续连接
  - 多个邮件发往同一个邮件服务器时,可以只建立一个tcp连接

SMTP握手协议
![image.png](https://tva1.sinaimg.cn/large/008tG9v6ly1h62r87o0cyj30cf06g3zh.jpg)

## 2.3.2 与HTTP的区别

- HTTP是拉协议,由想接受文件的机器发起,SMTP是推协议,由发送文件的服务器发起
- 只有SMTP每个报文(包括体)都要用7比特ASCII码格式
- SMTP把所有对象放在一个报文中发送,而HTTP是每个对象分别发送

## 2.3.4 邮件访问协议

POP3,IMAP,HTTP协议被用于将邮件服务器上的接收邮件传输到接收方的用户代理上

- POP3
  - 特许(authorization)阶段: 用户代理以明文形式发送用户名和口令鉴别用户
  - 事务处理阶段:用户代理取回报文;对报文做删除标记;取消报文删除标记;获取邮件的统计信息
    服务器回答有 OK(后面跟有服务器到客户的数据)  和  ERR
  - 更新阶段(于quit指令后开始):结束会话,服务器删除被标记为删除的报文
- POP3服务器会保留一些状态信息,但不会在会话中携带任何状态信息

- IMAP
  - 其允许用户在服务器上把每个报文与一个文件夹联系起来
  - 会话中包含状态信息
  - 允许用户代理只读取报文的一部分以适应低带宽
- 基于web的电子邮件
  - 用户代理是浏览器
  - 用户代理与邮件服务器通信通过HTTP来进行
  - 而邮件服务器与邮件服务器之间的通信仍然通过SMTP来完成.